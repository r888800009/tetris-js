<canvas id="screen" width="600" height="600" style="border:1px solid #555555;"></canvas>
<script>
var screen = {
    width: 600,
    height: 600,
    context: null,
    blockSize: 20,
    fps: 100.0
};

var keyBool = new Array(128).fill(false);

var colors = {
    blocks:         [
                        "#996600",
                        "#6688EE",
                        "#FFCC00",
                        "#CC9933",
                        "#EE99CC",
                        "#9933EE",
                        "#BB99FF"
                    ],
    bg:             "#555555",
    screenBG:       "#000000",
    screenBlock:    "#222222"
};

var map = {
    data: null,
    height: 20,
    width: 10,
    display: {
        x: 10,
        y: 10
    }
};

var queueDisplayX = (map.width + 1) * screen.blockSize,
    queueDisplayY = map.display.y;

var gameRunning = true;
var gameTimer;
var pointX = 0, pointY = 0;
var blocks = [
    [
        1,1,1,1,
        0,0,0,0,
        0,0,0,0,
        0,0,0,0
    ],
    [
        2,2,2,0,
        0,0,2,0,
        0,0,0,0,
        0,0,0,0
    ],
    [
        3,3,3,0,
        3,0,0,0,
        0,0,0,0,
        0,0,0,0
    ],
    [
        4,4,0,0,
        4,4,0,0,
        0,0,0,0,
        0,0,0,0
    ],
    [
        0,5,5,0,
        5,5,0,0,
        0,0,0,0,
        0,0,0,0
    ],
    [
        6,6,6,0,
        0,6,0,0,
        0,0,0,0,
        0,0,0,0
    ],
    [
        7,7,0,0,
        0,7,7,0,
        0,0,0,0,
        0,0,0,0
    ],
];

var useBlock;
var queueBlock;

function createNewMap()
{
    // allocation map data
    map.data = Array.from(Array(map.width),
        () => Array(map.height).fill(0));

    // create block queue 5 item
    queueBlock= Array.from(Array(5),
        () => Math.floor(Math.random() * 7))

    // add first block
    newBlock();
}

function newBlock()
{
    // next block
    var blockUse = queueBlock.shift();
    queueBlock.push(Math.floor(Math.random() * 7));
    useBlock = blocks[blockUse].slice();

    // put at upper center
    pointX = map.width / 2 - 2;
    pointY = 0;
}

function gameStart()
{
    createNewMap();
    gameRunning = true;
    gameTimer = setInterval(gameTick, 500);
}

function gameMenu()
{

}

function gameGameOverMenu()
{

}

function main()
{
    // set screen
    screen1 = document.getElementById('screen');   
    context = screen.context = screen1.getContext('2d');

    // init
    DisplayTimer = setInterval(display, 1000.0 / screen.fps);
    gameStart(); 

    return 0; 
}

function gameTick()
{
    moveDown();
}

function blockPaint(onScreenX, onScreenY, x, y, useBlackground)
{
    context = screen.context;
    if (useBlackground == 0)
        context.fillStyle = colors.screenBlock;
    else 
        context.fillStyle = colors.blocks[useBlackground - 1];

    context.fillRect(onScreenX + (screen.blockSize) * x + 1,
                 onScreenY + (screen.blockSize) * y + 1,
                 screen.blockSize - 2, screen.blockSize - 2);
}

function display()
{
    context = screen.context;
    // clean screen
    context.fillStyle = colors.bg;
    context.fillRect(0, 0, screen.width, screen.height);

    // Display background
    context.fillStyle = colors.screenBG;
    context.fillRect(map.display.x, map.display.y, screen.blockSize * map.width, screen.blockSize * map.height);

    for (var x = 0; x < map.width; x++) {
        for (var y = 0; y < map.height; y++) {
            blockPaint(map.display.x, map.display.y, x, y, map.data[x][y]);
        }
    }

    // Display blocks
    for (var x = 0; x < 4; x++) {
        for (var y = 0; y < 4; y++) {
            // Block queue
            if(blocks[queueBlock[0]][x + y * 4] != 0) {
                blockPaint(queueDisplayX, queueDisplayY, x, y,
                           blocks[queueBlock[0]][x + y * 4]);
            }

            // Block current
            if (useBlock[x + y * 4] != 0) {
                blockPaint(map.display.x, map.display.y, pointX + x, pointY + y,
                           useBlock[x + y * 4]);    
            }
        }
    }
}

function gameOver()
{
    gameRunning = false;
    window.clearInterval(gameTimer);
}

function collisionTest(addX, addY)
{
    for (var x = 0; x < 4; x++) {
        for (var y = 0; y < 4; y++) {

            if (useBlock[x + y * 4] == 0) 
                continue;
            
            if (pointX + x + addX <  0    ||
                pointX + x + addX >= map.width ||
                pointY + y + addY >= map.height )
            {
                return true;
            }
            else if (map.data[pointX + x + addX][pointY + y + addY] != 0)
                return true;
            
        }
    }
    return false;
}

function lineTest()
{

}
//event

function rotate() 
{

}

function moveRight() 
{
    if (!collisionTest(1, 0))
        pointX++;
}

function moveLeft() 
{
    if (!collisionTest(-1, 0))
        pointX--;
}

function moveDown()
{
    if (gameRunning == false) 
        return;
    
    if (!collisionTest(0, 1))
        pointY++;
    else {
        if (pointY == 0)
            gameOver();
        
        for (var x = 0; x < 4; x++) {
            for (var y = 0; y < 4; y++) {
                if (useBlock[x + y * 4] != 0)
                    map.data[pointX + x][pointY + y] = useBlock[x + y * 4];
            }
            lineTest();
        }
        newBlock();
    }
}

function keyDown(e)
{
    e = e || window.event;


    if (!(e.keyCode < 128) || keyBool[e.keyCode] == true)
        return;

    keyBool[e.keyCode] == true;
    console.log("keyDown");
    
    if([38, 40, 37, 39].indexOf(e.keyCode) > -1) 
        e.preventDefault();

    if (e.keyCode == '38') // up
        rotate();
    
    if (e.keyCode == '40') // down
        moveDown();
    
    if (e.keyCode == '37') // left
        moveLeft();
    
    if (e.keyCode == '39') // right
        moveRight();

    display();
}

function keyUp(e)
{
    e = e || window.event;

    if (e.keyCode < 128 && keyBool[e.keyCode] == true) 
        keyBool[e.keyCode] == false;
    
}

window.onload    = main;
window.onkeydown = keyDown;
window.onkeyup   = keyUp;
</script>
<br>
The game is not done.
<a href="https://github.com/r888800009/tetris-js">
    <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub">
</a>
<br>
<a href="https://github.com/r888800009/">r888800009</a>
